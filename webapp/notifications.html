<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ghinbox</title>
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const cacheBust = params.get('cache_bust') || localStorage.getItem('ghnotif_cache_bust');
            if (cacheBust) {
                localStorage.setItem('ghnotif_cache_bust', cacheBust);
            }
            const bust = cacheBust ? `?v=${encodeURIComponent(cacheBust)}` : '';
            document.write(
                '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown-light.css">'
            );
            document.write(`<link rel="stylesheet" href="notifications.css${bust}">`);
        })();
    </script>
    <style>
        .container {
            max-width: 1200px;
        }

        .comment-item {
            font-size: 14px;
            line-height: 1.5;
        }

        .comment-item .comment-meta {
            font-size: 12px;
        }

        .comment-body,
        .comment-body.markdown-body {
            font-size: 14px;
            line-height: 1.5;
        }

        .comment-body details.collapsed-versions {
            margin: 8px 0;
        }

        .comment-body details.collapsed-versions summary {
            cursor: pointer;
            font-weight: 600;
        }

        .comment-body details.collapsed-versions[open] summary {
            margin-bottom: 4px;
        }

        @media (max-width: 640px) {
            .notifications-container {
                overflow-x: hidden;
            }

            .notification-item {
                flex-wrap: wrap;
                gap: 8px;
                padding: 12px 10px;
            }

            .notification-icon {
                order: 1;
                margin-top: 0;
            }

            .notification-content {
                display: contents;
            }

            .notification-header {
                display: contents;
            }

            .notification-title {
                order: 2;
                flex: 1 1 calc(100% - 24px);
                min-width: 0;
            }

            .notification-meta {
                order: 4;
                flex: 1 1 60%;
                min-width: 0;
                gap: 6px;
            }

            .comment-list {
                order: 6;
                flex-basis: 100%;
                margin-top: 8px;
                gap: 6px;
            }

            .comment-item {
                padding: 8px;
            }

            .notification-actions-bottom {
                order: 7;
                width: 100%;
                justify-content: flex-start;
            }

            .notification-actions-inline {
                order: 4;
                margin-top: 0;
                justify-content: flex-start;
                flex-wrap: wrap;
                margin-left: auto;
            }

            .notification-time {
                white-space: normal;
            }

            .notification-actors {
                order: 4;
                margin-top: 0;
            }

            .notification-checkbox {
                order: 3;
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-inner">
            <h1>ghinbox</h1>
            <div class="header-links">
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Controls Section -->
        <section class="controls">
            <div class="controls-row">
                <div class="input-group">
                    <label for="repo-input">Repository:</label>
                    <input
                        type="text"
                        id="repo-input"
                        placeholder="owner/repo"
                        aria-label="Repository in owner/repo format"
                    >
                </div>
                <button id="sync-btn" class="btn btn-primary" type="button">
                    Quick Sync
                </button>
                <button id="full-sync-btn" class="btn" type="button">
                    Full Sync
                </button>
                <button id="force-refresh-btn" class="btn btn-small" type="button">
                    Force refresh
                </button>
                <span id="auth-status" class="auth-status">Checking auth...</span>
            </div>
            <div class="controls-row secondary">
                <label class="comment-toggle" for="comment-prefetch-toggle">
                    <input type="checkbox" id="comment-prefetch-toggle">
                    Fetch comments and reviews for triage filters
                </label>
                <label class="comment-expand" for="comment-expand-toggle">
                    <input type="checkbox" id="comment-expand-toggle">
                    Show unread comments
                </label>
                <label class="comment-hide" for="comment-hide-uninteresting-toggle">
                    <input type="checkbox" id="comment-hide-uninteresting-toggle">
                    Hide uninteresting comments
                </label>
                <div class="comment-cache-actions">
                    <span id="comment-cache-status" class="comment-cache-status"></span>
                    <button id="clear-comment-cache-btn" class="btn btn-small" type="button">
                        Clear cache
                    </button>
                </div>
            </div>
            <div id="status-bar" class="status-bar"></div>
            <div id="rate-limit-box" class="rate-limit-box">Rate limit: unknown</div>
        </section>

        <!-- Notifications Section -->
        <section class="notifications-container">
            <header class="notifications-header">
                <h2>Notifications</h2>
                <span id="notification-count"></span>
            </header>

            <!-- Primary View Tabs -->
            <nav class="view-tabs" role="tablist" aria-label="View notifications by type">
                <button
                    class="view-tab active"
                    role="tab"
                    aria-selected="true"
                    data-view="issues"
                    id="view-issues"
                >
                    Issues <span class="count">0</span>
                </button>
                <button
                    class="view-tab"
                    role="tab"
                    aria-selected="false"
                    data-view="my-prs"
                    id="view-my-prs"
                >
                    My PRs <span class="count">0</span>
                </button>
                <button
                    class="view-tab"
                    role="tab"
                    aria-selected="false"
                    data-view="others-prs"
                    id="view-others-prs"
                >
                    Others' PRs <span class="count">0</span>
                </button>
            </nav>

            <!-- Subfilter Tabs for Issues -->
            <nav class="subfilter-tabs" role="tablist" aria-label="Filter issues" data-for-view="issues">
                <button
                    class="subfilter-tab active"
                    role="tab"
                    aria-selected="true"
                    data-subfilter="all"
                >
                    All <span class="count">0</span>
                </button>
                <button
                    class="subfilter-tab"
                    role="tab"
                    aria-selected="false"
                    data-subfilter="open"
                >
                    Open <span class="count">0</span>
                </button>
                <button
                    class="subfilter-tab"
                    role="tab"
                    aria-selected="false"
                    data-subfilter="closed"
                >
                    Closed <span class="count">0</span>
                </button>
            </nav>

            <!-- Subfilter Tabs for My PRs (minimal for now) -->
            <nav class="subfilter-tabs hidden" role="tablist" aria-label="Filter my PRs" data-for-view="my-prs">
                <button
                    class="subfilter-tab active"
                    role="tab"
                    aria-selected="true"
                    data-subfilter="all"
                >
                    All <span class="count">0</span>
                </button>
            </nav>

            <!-- Subfilter Tabs for Others' PRs -->
            <nav class="subfilter-tabs hidden" role="tablist" aria-label="Filter others' PRs" data-for-view="others-prs">
                <button
                    class="subfilter-tab active"
                    role="tab"
                    aria-selected="true"
                    data-subfilter="all"
                >
                    All <span class="count">0</span>
                </button>
                <button
                    class="subfilter-tab"
                    role="tab"
                    aria-selected="false"
                    data-subfilter="needs-review"
                >
                    Needs review <span class="count">0</span>
                </button>
                <button
                    class="subfilter-tab"
                    role="tab"
                    aria-selected="false"
                    data-subfilter="approved"
                >
                    Approved <span class="count">0</span>
                </button>
                <button
                    class="subfilter-tab"
                    role="tab"
                    aria-selected="false"
                    data-subfilter="closed"
                >
                    Closed <span class="count">0</span>
                </button>
            </nav>

            <div id="select-all-row" class="select-all-row" style="display: none;">
                <input
                    type="checkbox"
                    id="select-all-checkbox"
                    class="select-all-checkbox"
                    aria-label="Select all notifications"
                >
                <label for="select-all-checkbox" class="select-all-label">Select all</label>
                <span id="selection-count" class="selection-count"></span>
                <button id="mark-done-btn" class="btn btn-danger" style="display: none;">
                    Mark selected as Done
                </button>
                <button id="unsubscribe-all-btn" class="btn btn-danger" style="display: none;">
                    Unsubscribe from all
                </button>
            </div>

            <div id="progress-container" class="progress-container">
                <div class="progress-bar-bg">
                    <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
                </div>
                <div id="progress-text" class="progress-text"></div>
            </div>

            <div id="loading" class="loading">
                Loading notifications...
            </div>

            <div id="empty-state" class="empty-state">
                <h3>No notifications</h3>
                <p>Enter a repository and click Quick Sync to load notifications.</p>
            </div>

    <ul id="notifications-list" class="notifications-list" role="list">
        <!-- Notifications will be rendered here -->
    </ul>
</section>
</main>

    <!-- Keyboard Shortcuts Help Overlay -->
    <div id="keyboard-shortcuts-overlay" class="keyboard-shortcuts-overlay" role="dialog" aria-modal="true" aria-labelledby="keyboard-shortcuts-title">
        <div class="keyboard-shortcuts-modal">
            <div class="keyboard-shortcuts-header">
                <h3 id="keyboard-shortcuts-title">Keyboard Shortcuts</h3>
                <button class="keyboard-shortcuts-close" aria-label="Close" id="keyboard-shortcuts-close">
                    <svg viewBox="0 0 16 16" fill="currentColor">
                        <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
                    </svg>
                </button>
            </div>
            <div class="keyboard-shortcuts-content">
                <div class="keyboard-shortcuts-section">
                    <h4>Navigation</h4>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Move down</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">j</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Move up</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">k</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Scroll to top</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">g</kbd><kbd class="keyboard-shortcut-key">g</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Scroll to bottom</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">G</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Open notification</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">Enter</kbd></div>
                    </div>
                </div>
                <div class="keyboard-shortcuts-section">
                    <h4>Actions</h4>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Mark as done</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">e</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Unsubscribe</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">m</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Undo last action</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">u</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Reload page</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">r</kbd></div>
                    </div>
                </div>
                <div class="keyboard-shortcuts-section">
                    <h4>Selection</h4>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Toggle selection</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">t</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Select all</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">Ctrl</kbd><kbd class="keyboard-shortcut-key">a</kbd></div>
                    </div>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Clear selection</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">Esc</kbd></div>
                    </div>
                </div>
                <div class="keyboard-shortcuts-section">
                    <h4>Help</h4>
                    <div class="keyboard-shortcut-row">
                        <span class="keyboard-shortcut-desc">Show this help</span>
                        <div class="keyboard-shortcut-keys"><kbd class="keyboard-shortcut-key">?</kbd></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const cacheBust = params.get('cache_bust') || localStorage.getItem('ghnotif_cache_bust');
            if (cacheBust) {
                localStorage.setItem('ghnotif_cache_bust', cacheBust);
            }
            const bust = cacheBust ? `?v=${encodeURIComponent(cacheBust)}` : '';
            document.write(`<script src="notifications-comments.js${bust}"><\/script>`);
            document.write(`<script src="notifications-core.js${bust}"><\/script>`);
            document.write(`<script src="notifications-sync.js${bust}"><\/script>`);
            document.write(`<script src="notifications-actions.js${bust}"><\/script>`);
            document.write(`<script src="notifications-ui.js${bust}"><\/script>`);
            document.write(`<script src="notifications.js${bust}"><\/script>`);
        })();
    </script>
    <script>
        (function () {
            function collapseVersionsSection(markdown) {
                const text = String(markdown ?? '');
                const lines = text.split('\n');
                const output = [];
                let changed = false;
                let i = 0;
                while (i < lines.length) {
                    const line = lines[i];
                    const match = line.match(/^(#{1,6})\s+Versions\s*$/i);
                    if (!match) {
                        output.push(line);
                        i += 1;
                        continue;
                    }
                    const level = match[1].length;
                    let j = i + 1;
                    while (j < lines.length) {
                        const headingMatch = lines[j].match(/^(#{1,6})\s+.+$/);
                        if (headingMatch && headingMatch[1].length <= level) {
                            break;
                        }
                        j += 1;
                    }
                    const sectionLines = lines.slice(i + 1, j);
                    output.push('<details class="collapsed-versions">');
                    output.push('<summary>Versions</summary>');
                    if (sectionLines.length > 0) {
                        output.push('');
                        output.push(...sectionLines);
                    }
                    output.push('</details>');
                    changed = true;
                    i = j;
                }
                return changed ? output.join('\n') : text;
            }

            function wrapRenderMarkdown() {
                if (typeof renderMarkdown !== 'function') {
                    return;
                }
                const original = renderMarkdown;
                window.renderMarkdown = function (text) {
                    return original(collapseVersionsSection(text));
                };
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', wrapRenderMarkdown);
            } else {
                wrapRenderMarkdown();
            }
        })();
    </script>
    <script>
        (function () {
            const forceRefreshBtn = document.getElementById('force-refresh-btn');
            if (!forceRefreshBtn) {
                return;
            }
            forceRefreshBtn.addEventListener('click', () => {
                const cacheBust = Date.now().toString();
                localStorage.setItem('ghnotif_cache_bust', cacheBust);
                const url = new URL(window.location.href);
                url.searchParams.set('cache_bust', cacheBust);
                window.location.replace(url.toString());
            });
        })();
    </script>
</body>
</html>
